<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facility Data Analysis System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { 
  background: white;
  min-height: 100vh;
  display: flex; 
  align-items: center; 
  justify-content: center;
  flex-direction: column; 
  margin: 0; 
}
.login-box { 
  background: white; 
  padding: 2rem; 
  border-radius: 8px; 
  box-shadow: 0 0 10px rgba(0,0,0,0.1); 
  width: 350px;
  margin-bottom: 2rem;
}
</style>
</head>
<body>

<!--Login Box -->
<div class="login-box text-center" id="authSection">
  <h5 class="mb-3">Facility Login</h5>
  <input type="text" id="usernameInput" placeholder="Username" class="form-control mb-2">
  <input type="password" id="passwordInput" placeholder="Password" class="form-control mb-2">
  <div class="form-check mb-2 text-start">
    <input type="checkbox" class="form-check-input" id="rememberMe">
    <label class="form-check-label" for="rememberMe">Remember Me</label>
  </div>
  <button class="btn btn-primary w-100 mb-2" id="loginBtn">Login</button>
  <button class="btn btn-secondary w-100 mb-2" id="registerBtn">Register</button>
  <p class="forgot-pass" id="forgotPassBtn">Forgot Password?</p>
  <p id="loginMsg" class="text-danger mt-2"></p>
</div>

<!-- Facility Section -->
<div class="container-fluid d-none" id="facilitySection">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Facility Data System</h4>
    <div>
      <span id="currentUserBadge" class="badge bg-light text-dark me-2"></span>
      <button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="facilityTabs">
    <li class="nav-item">
      <button class="nav-link active" id="data-input-tab" data-bs-toggle="tab" data-bs-target="#dataInputTab" type="button">Data Input</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="data-analysis-tab" data-bs-toggle="tab" data-bs-target="#dataAnalysisTab">Data Analysis</button>
    </li>
  </ul>

  <div class="tab-content card p-3 mt-2">

    <!-- Data Input Tab -->
    <div class="tab-pane fade show active" id="dataInputTab">
      <div class="mb-2">
        <select id="SECTOR" class="form-select w-auto d-inline-block">
          <option value="">Select Sector</option>
          <option value="tea">TEA</option>
          <option value="hotel">HOTEL</option>
          <option value="cement">CEMENT</option>
          <option value="other">other</option>
        </select>
        <input type="text" id="other-sector" placeholder="Please specify" style="display:none;" class="form-control w-auto d-inline-block">
      </div>

      <div class="summary-box">
        <h5>Facility Details</h5>
        <input type="text" id="facilityNameInput" class="form-control w-auto d-inline-block mb-2" placeholder="Enter Facility Name">
        <input type="file" id="facilityExcelUpload" accept=".xlsx, .xls" class="form-control w-auto d-inline-block mb-2">
        <button class="btn btn-primary btn-sm" id="processExcelBtn">Process Excel</button>
        <button class="btn btn-success btn-sm" id="submitFacilityBtn" disabled>Submit to Admin</button>
        <p id="facilityStatus" class="mt-2 text-muted"></p>
      </div>
      <div id="facilityInputs"></div>

      <div class="summary-box mt-3">
        <h5>My Submissions</h5>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>Facility</th>
              <th>Submitted At</th>
              <th>Status</th>
              <th>Admin Comment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="facilitySubmissionsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Data Analysis Tab -->
    <div class="tab-pane fade" id="dataAnalysisTab">
      <button class="btn btn-info btn-sm mb-2" id="regressionbtn" disabled>Benchmark Model</button>
      <div id="facilityResults"></div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const USERS_KEY = 'facilityUsers_v1';
  const STORAGE_KEY = 'submittedFacilityData_v5';
  let currentUser = null;
  let workingSubmission = null;


  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');
  const forgotPassBtn = document.getElementById('forgotPassBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const rememberMe = document.getElementById('rememberMe');
  const loginMsg = document.getElementById('loginMsg');
  const authSection = document.getElementById('authSection');
  const facilitySection = document.getElementById('facilitySection');
  const currentUserBadge = document.getElementById('currentUserBadge');

  const facilityNameInput = document.getElementById('facilityNameInput');
  const fileInput = document.getElementById('facilityExcelUpload');
  const facilityInputs = document.getElementById('facilityInputs');
  const facilitySubmissionsTable = document.getElementById('facilitySubmissionsTable');
  const facilityResults = document.getElementById('facilityResults');
  const computeBtn = document.getElementById('computeBtn');
  const getUsers = () => JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
  const saveUsers = (arr) => localStorage.setItem(USERS_KEY, JSON.stringify(arr));
  const getAllSubmissions = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const saveAllSubmissions = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  const parseCell = (v) => { const n=parseFloat(v); return isNaN(n)?null:n; };
  const sumNonNull = arr => arr.reduce((s,v)=>s+(v==null?0:v),0);
  const setFacilityStatusText = (msg, cls) => { facilityStatus.textContent = msg; facilityStatus.className = cls; };

 
  const registerUser = () => {
    const username=usernameInput.value.trim();
    const password=passwordInput.value.trim();
    if(!username||!password)return alert('Enter username and password.');
    const users=getUsers();
    if(users.find(u=>u.username===username))return alert('Username exists.');
    users.push({username,password}); saveUsers(users);
    alert('Registration successful.');
  };

  const loginUser = () => {
    const username=usernameInput.value.trim();
    const password=passwordInput.value.trim();
    const user=getUsers().find(u=>u.username===username && u.password===password);
    if(!user){ loginMsg.textContent='Invalid username or password.'; return; }
    currentUser=username;
    currentUserBadge.textContent=username;
    sessionStorage.setItem('loggedUser', username);
    if(rememberMe.checked) localStorage.setItem('rememberedUser', JSON.stringify({username,password}));
    else localStorage.removeItem('rememberedUser');
    authSection.classList.add('d-none');
    facilitySection.classList.remove('d-none');
    renderFacilitySubmissions();
  };

  const logoutUser = () => {
    currentUser=null;
    sessionStorage.removeItem('loggedUser');
    authSection.classList.remove('d-none');
    facilitySection.classList.add('d-none');
  };

  const forgotPassword = () => {
    const username=prompt('Enter your username to reset password:');
    if(!username)return;
    const users=getUsers();
    const user=users.find(u=>u.username===username);
    if(!user)return alert('Username not found.');
    const newPass=prompt('Enter new password:');
    if(!newPass)return alert('Password reset unsuccessfull.');
    user.password=newPass; saveUsers(users);
    alert('Password reset successful.');
  };

  registerBtn.onclick=registerUser;
  loginBtn.onclick=loginUser;
  logoutBtn.onclick=logoutUser;
  forgotPassBtn.onclick=forgotPassword;

const remembered = JSON.parse(localStorage.getItem('rememberedUser')||'{}');
  if(remembered.username){ usernameInput.value=remembered.username; passwordInput.value=remembered.password; rememberMe.checked=true; }


 const SECTOR = document.getElementById("SECTOR");
 const otherInput = document.getElementById("other-sector");

 otherInput.style.display = "none";
 SECTOR.addEventListener("change", function() {
    if(SECTOR.value === "other") {
        otherInput.style.display = "block";
    } else {
	otherInput.value = "";
        otherInput.style.display = "none";
    }
  });

  
const processExcelBtn = document.getElementById('processExcelBtn');
  processExcelBtn.onclick = () => {
    const name = facilityNameInput.value.trim();
    if(!name) return alert('Enter facility name.');
    if(!fileInput.files.length) return alert('Select an Excel file.');
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const sheet=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(sheet,{header:1});
      if(data.length<2)return alert('Invalid Excel.');
      const headers = data[0];
      facilityInputs.innerHTML = `<table class="table table-bordered table-sm">
        ${data.map(r=>`<tr>${r.map(c=>`<td contenteditable="true">${c??''}</td>`).join('')}</tr>`).join('')}
      </table>`;
      workingSubmission = { facilityName:name, headers, rows: data.slice(1) };
      submitFacilityBtn.disabled=false;
      setFacilityStatusText('Excel loaded successfully.','text-success');
    };
    reader.readAsArrayBuffer(file);
  };

const submitFacilityBtn = document.getElementById('submitFacilityBtn');
  submitFacilityBtn.onclick = () => {
    if(!currentUser)return alert('Login first.');
    if(!workingSubmission?.rows)return alert('Process Excel first.');

    let sectorValue = SECTOR.value;
    if(sectorValue === "other") sectorValue = otherInput.value.trim();

    const sub = {
      id: 'sub_'+Date.now(),
      username: currentUser,
      facilityName: workingSubmission.facilityName,
      sector: sectorValue || '',
      headers: workingSubmission.headers,
      rows: workingSubmission.rows,
      status: 'Pending Approval',
      adminComment: '',
      submittedAt: new Date().toISOString()
    };

    const all = getAllSubmissions(); all.push(sub); saveAllSubmissions(all);
    alert('Submission sent to Admin.');
    setFacilityStatusText('Submitted and awaiting approval.','text-info');
    renderFacilitySubmissions();
  };

  const renderFacilitySubmissions = () => {
    facilitySubmissionsTable.innerHTML='';
    if(!currentUser)return;
    const all = getAllSubmissions().filter(s=>s.username===currentUser).sort((a,b)=>new Date(b.submittedAt)-new Date(a.submittedAt));
    if(!all.length){ facilitySubmissionsTable.innerHTML='<tr><td colspan="5">No submissions yet.</td></tr>'; return; }
    all.forEach(s=>{
      const statusClass = s.status==='Approved'?'bg-success':s.status==='Referred Back'?'bg-danger':'bg-secondary';
      facilitySubmissionsTable.innerHTML+=`
        <tr>
          <td>${s.facilityName} (${s.sector||''})</td>
          <td>${new Date(s.submittedAt).toLocaleString()}</td>
          <td><span class="badge ${statusClass}">${s.status}</span></td>
          <td>${s.adminComment||''}</td>
          <td><button class="btn btn-sm btn-info" onclick="downloadSubmission('${s.id}')">Download</button></td>
        </tr>
      `;
    });
  };

  window.downloadSubmission = (id) => {
    const sub = getAllSubmissions().find(s=>s.id===id);
    if(!sub) return alert('Submission not found.');
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([sub.headers,...sub.rows]);
    XLSX.utils.book_append_sheet(wb,ws,'Raw Data');
    XLSX.writeFile(wb,`${sub.facilityName}_Submission.xlsx`);
  };

  
  const logged = sessionStorage.getItem('loggedUser');
  if(logged){ currentUser=logged; currentUserBadge.textContent=logged; authSection.classList.add('d-none'); facilitySection.classList.remove('d-none'); renderFacilitySubmissions(); }

  window.addEventListener('storage',(e)=>{ if(e.key===STORAGE_KEY) renderFacilitySubmissions(); });

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
