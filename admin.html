<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Review (EPRA)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .summary-box {
	background: #fff; 
	padding:12px; 
	border-radius:6px; 
	box-shadow:0 0 6px rgba(0,0,0,0.05); 
    }
    .admin-layout { 
	display:flex;
	gap:1rem; align-items:flex-start;
    }
    .admin-tabs-vertical {
	 flex:0 0 220px; 
    }
    .admin-content-area {
	 flex-grow:1; 
    }
    th { 
	background: #f1f1f1; 
    }
    table {
	font-size: 14px; 
    }
  </style>
</head>
<body class="p-3">
  <div class="container-fluid">
    <h3 class="text-center mb-4">Facility Data Submission & Review</h3>

    <div class="summary-box">
      <div class="admin-layout">
        <ul class="nav flex-column nav-pills admin-tabs-vertical" role="tablist" aria-orientation="vertical">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#newSubs" type="button">New Submissions</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#approvedSubs" type="button">Approved</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#referredSubs" type="button">Referred Back </button></li>
          <li class="nav-item"><a class="nav-link" href="analysis.html" target="_blank"> EER Analysis</a></li>
        </ul>

        <div class="tab-content admin-content-area">
          <div class="tab-pane fade show active" id="newSubs">
            <div id="adminContainerNew"></div>
          </div>

          <div class="tab-pane fade" id="approvedSubs">
            <div id="adminContainerApproved"></div>
          </div>

          <div class="tab-pane fade" id="referredSubs">
            <div id="adminContainerReferred"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = 'submittedFacilityData_v5';

  const getAllSubmissions = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

 

  function renderAdminTables() {
    const all = getAllSubmissions();
    renderTable('adminContainerNew', all.filter(s => s.status === 'Pending Approval'));
    renderTable('adminContainerApproved', all.filter(s => s.status === 'Approved'));
    renderTable('adminContainerReferred', all.filter(s => s.status === 'Referred Back'));
  }

  function renderTable(containerId, arr) {
    const el = document.getElementById(containerId);
    if (!arr.length) { el.innerHTML = '<p class="text-muted">No records found.</p>'; return; }
    el.innerHTML = `
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
		<th>Facility</th>
		<th>Sector</th>
		<th>User</th>
		<th>Status</th>
		<th>Submitted</th>
		<th>Action</th>
	  </tr>
        </thead>
        <tbody>
          ${arr.map(s => `
            <tr>
              <td>${escapeHtml(s.facilityName)}</td>
	      <td>${escapeHtml(s.sector)}</td>
              <td>${escapeHtml(s.username)}</td>
              <td>${escapeHtml(s.status)}</td>
              <td>${new Date(s.submittedAt).toLocaleString()}</td>
              <td><button class="btn btn-primary btn-sm" onclick="openAdminReview('${s.id}')">Review</button></td>
            </tr>`).join('')}
        </tbody>
      </table>
    `;
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'", '&#39;');
  }

  window.openAdminReview = (id) => {
    window.location.href = `review.html?id=${encodeURIComponent(id)}`;
  };

  window.addEventListener('storage', (e) => {
    if (e.key === STORAGE_KEY) renderAdminTables();
  });

  renderAdminTables();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
